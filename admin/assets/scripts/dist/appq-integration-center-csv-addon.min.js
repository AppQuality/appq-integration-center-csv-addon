var $bugsListContainer,$availableFieldsContainer,$saveCSVExport,$bugTracker,$csvSettingsForm,$newMappingButton,$editMappingModalButton,$submitButton,$integrationCenterButtons={sendAll:null,sendSelected:null,sendSingle:null},bugIDs=[],inspectionIDs=[],sendClicked=!1,bugCollectorInterval=!1,enableBugUpload=!1,_x=wp.i18n._x;function clickAvailableField(){var e=jQuery(this);e.hasClass("selected")?e.removeClass("selected"):e.addClass("selected")}function clickSaveCSVExport(){if("csv_exporter"==jQuery("#setup_manually_cp [name='bugtracker']").val().trim().toLowerCase()){var e=jQuery("#available-csv-fields").select2("data");if(console.log("FIelds",e),$submitButton.hasClass("locked"))return!1;if($submitButton.addClass("locked").attr("disabled","disabled").find("i").addClass("fa-spinner"),!e.length)return toastr.error(_x("Select some fields first!","Integration Center Csv export field selection","appq-integration-center-csv-addon")),$submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner"),!1;var a=$csvSettingsForm.serializeArray();console.log("FormData",a);var t={};e.forEach(function(e){var a={};a.value=e.text,a.key=e.id,jQuery(this).hasClass("selected")?a.selected=1:a.selected=0,t[jQuery(this).data("key")]=a}),a.push({name:"cp_id",value:cp_id}),a.push({name:"action",value:"save_csv_export"}),jQuery.ajax({url:ajax_object.ajax_url,type:"POST",data:a,success:function(e){if($submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner"),void 0!==e){var a=e;a.data&&a.data.message&&toastr[a.data.type](a.data.message),location.reload()}},error:function(e){console.log(e),$submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner")}})}}function clickSend(e){if("csv_exporter"!=jQuery("#setup_manually_cp [name='bugtracker']").val().trim().toLowerCase())return!1;var a=jQuery(this).data("bug-id");-1==bugIDs.indexOf(a)&&bugIDs.push(a),sendClicked||(sendClicked=!0,bugCollectorInterval=setInterval(saveCSVExport,32))}function saveCSVExport(){inspectionIDs=bugIDs.toString()==inspectionIDs.toString()?(sendClicked=!1,clearInterval(bugCollectorInterval),jQuery.ajax({url:ajax_object.ajax_url,type:"POST",headers:{"Content-Transfer-Encoding":"UTF-8"},data:{action:"download_csv_export",cp_id:cp_id,bug_ids:bugIDs},beforeSend:function(){enableBugUpload||jQuery("#bugs_list .is_uploaded .fa-check").remove()},success:function(e){if(void 0!==e){var a=e;if(a.data&&a.data.message&&toastr[a.data.type](a.data.message),a.success){var t=document.createElement("a");t.download=a.data.file_name,t.href=a.data.download_url,document.body.appendChild(t),t.click(),setTimeout(function(){document.body.removeChild(t)},50),deleteCSVExport(a.data)}enableBugUpload||(jQuery("#bugs_list .upload_bug").removeClass("disabled"),jQuery("#bugs_list .upload_bug").removeClass("text-secondary"),jQuery("#bugs_list .check:checked").prop("checked",!1))}},error:function(e){console.log(e),enableBugUpload||(jQuery("#bugs_list .upload_bug").removeClass("disabled"),jQuery("#bugs_list .upload_bug").removeClass("text-secondary"),jQuery("#bugs_list .check:checked").prop("checked",!1))}}),bugIDs=[]):bugIDs}function newFieldMapping(){var e=jQuery("#add_mapping_field_modal #mapping_modal_key").val(),a=jQuery("#custom_mapping_name").val();e&&a&&jQuery.ajax({url:ajax_object.ajax_url,type:"POST",data:{action:"new_field_mapping",cp_id:cp_id,key:e,value:a},success:function(e){if(void 0!==e){var a=e;a.data&&a.data.message&&toastr[a.data.type](a.data.message),location.reload()}},error:function(e){console.log(e)}})}function editModalHandler(){jQuery("#add_mapping_field_modal #mapping_modal_key").val(jQuery(this).data("key"))}function deleteCSVExport(e){jQuery.ajax({url:ajax_object.ajax_url,type:"POST",data:{action:"appq_delete_csv_export",nonce:ajax_object.nonce,file_name:e.file_name},success:function(e){if(void 0!==e){var a=e;a.data&&a.data.message&&toastr[a.data.type](a.data.message)}},error:function(e){console.log(e)}})}jQuery(document).ready(function(){$bugsListContainer=jQuery("#bugs_list"),$availableFieldsContainer=jQuery("#available-fields"),$saveCSVExport=jQuery("#save-csv-export"),$integrationCenterButtons.sendAll=$bugsListContainer.find(".send-all"),$integrationCenterButtons.sendSelected=$bugsListContainer.find(".send-selected"),$integrationCenterButtons.sendSingle=$bugsListContainer.find("table"),$bugTracker=jQuery("#setup_manually_cp [name='bugtracker']"),$csvSettingsForm=jQuery("#csv_tracker_settings"),$newMappingButton=jQuery("#add_new_mapping_field"),$editMappingModalButton=jQuery('#csv_fields_settings button[data-toggle="modal"][data-target="#add_mapping_field_modal"]'),$submitButton=jQuery("#custom_tracker_settings_modal").find("button.confirm"),$availableFieldsContainer.on("click",".field",clickAvailableField),$submitButton.on("click",clickSaveCSVExport),$integrationCenterButtons.sendSingle.on("click",".upload_bug",clickSend),$integrationCenterButtons.sendSelected.on("click",clickSend),$integrationCenterButtons.sendAll.on("click",clickSend),$newMappingButton.on("click",newFieldMapping),$editMappingModalButton.on("click",editModalHandler)});