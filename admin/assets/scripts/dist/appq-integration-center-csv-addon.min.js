var $bugsListContainer,$availableFieldsContainer,$saveCSVExport,$bugTracker,$csvSettingsForm,$newMappingButton,$editMappingModalButton,$submitButton,$integrationCenterButtons={sendAll:null,sendSelected:null,sendSingle:null},bugIDs=[],inspectionIDs=[],sendClicked=!1,bugCollectorInterval=!1,enableBugUpload=!1,_x=wp.i18n._x;function clickSaveCSVExport(){if("csv_exporter"==jQuery("#setup_manually_cp [name='bugtracker']").val().trim().toLowerCase()){var e=jQuery("#available-csv-fields").find("option"),t=jQuery("#available-csv-fields").find("option:selected");if($submitButton.hasClass("locked"))return!1;if($submitButton.addClass("locked").attr("disabled","disabled").find("i").addClass("fa-spinner"),!t.length)return toastr.error(_x("Select some fields first!","Integration Center Csv export field selection","appq-integration-center-csv-addon")),$submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner"),!1;var a=$availableFormatsSelect.val(),n={};e.each(function(){var e=jQuery(this),t={};t.value=e.data("value"),t.description=e.data("description"),t.key=e.data("key"),this.selected?t.selected=1:t.selected=0,n[e.data("key")]=t});var i=JSON.stringify(n);jQuery.ajax({url:integration_center_obj.ajax_url,type:"POST",data:{action:"save_csv_export",cp_id:cp_id,field_keys:i,csv_endpoint:a},success:function(e){if($submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner"),void 0!==e){var t=e;t.data&&t.data.message&&toastr[t.data.type](t.data.message),location.reload()}},error:function(e){console.log(e),$submitButton.removeClass("locked").removeAttr("disabled").find("i").removeClass("fa-spinner")}})}}function clickSend(e){if("csv_exporter"!=jQuery("#setup_manually_cp [name='bugtracker']").val().trim().toLowerCase())return!1;var t=jQuery(this).data("bug-id");-1==bugIDs.indexOf(t)&&bugIDs.push(t),sendClicked||(sendClicked=!0,bugCollectorInterval=setInterval(saveCSVExport,32))}function saveCSVExport(){inspectionIDs=bugIDs.toString()==inspectionIDs.toString()?(sendClicked=!1,clearInterval(bugCollectorInterval),jQuery.ajax({url:integration_center_obj.ajax_url,type:"POST",headers:{"Content-Transfer-Encoding":"UTF-8"},data:{action:"download_csv_export",cp_id:cp_id,bug_ids:bugIDs},beforeSend:function(){enableBugUpload||jQuery("#bugs_list .is_uploaded .fa-check").remove()},success:function(e){if(void 0!==e){var t=e;if(t.data&&t.data.message&&toastr[t.data.type](t.data.message),t.success){var a=document.createElement("a");a.download=t.data.file_name,a.href=t.data.download_url,document.body.appendChild(a),a.click(),setTimeout(function(){document.body.removeChild(a)},50),deleteCSVExport(t.data)}enableBugUpload||(jQuery("#bugs_list .upload_bug").removeClass("disabled"),jQuery("#bugs_list .upload_bug").removeClass("text-secondary"),jQuery("#bugs_list .check:checked").prop("checked",!1))}},error:function(e){console.log(e),enableBugUpload||(jQuery("#bugs_list .upload_bug").removeClass("disabled"),jQuery("#bugs_list .upload_bug").removeClass("text-secondary"),jQuery("#bugs_list .check:checked").prop("checked",!1))}}),bugIDs=[]):bugIDs}function newFieldMapping(){var e=jQuery("#add_mapping_field_modal #mapping_modal_key").val(),t=jQuery("#custom_mapping_name").val();e&&t&&jQuery.ajax({url:integration_center_obj.ajax_url,type:"POST",data:{action:"new_field_mapping",cp_id:cp_id,key:e,value:t},success:function(e){if(void 0!==e){var t=e;t.data&&t.data.message&&toastr[t.data.type](t.data.message),location.reload()}},error:function(e){console.log(e)}})}function editModalHandler(){jQuery("#add_mapping_field_modal #mapping_modal_key").val(jQuery(this).data("key"))}function deleteCSVExport(e){jQuery.ajax({url:integration_center_obj.ajax_url,type:"POST",data:{action:"appq_delete_csv_export",nonce:integration_center_obj.nonce,file_name:e.file_name},success:function(e){if(void 0!==e){var t=e;t.data&&t.data.message&&toastr[t.data.type](t.data.message)}},error:function(e){console.log(e)}})}jQuery(document).ready(function(){$bugsListContainer=jQuery("#bugs_list"),$availableFieldsContainer=jQuery("#available-fields"),$availableFormatsSelect=jQuery("#available-formats"),$saveCSVExport=jQuery("#save-csv-export"),$integrationCenterButtons.sendAll=$bugsListContainer.find(".send-all"),$integrationCenterButtons.sendSelected=$bugsListContainer.find(".send-selected"),$integrationCenterButtons.sendSingle=$bugsListContainer.find("table"),$bugTracker=jQuery("#setup_manually_cp [name='bugtracker']"),$csvSettingsForm=jQuery("#csv_tracker_settings"),$newMappingButton=jQuery("#add_new_mapping_field"),$editMappingModalButton=jQuery('#csv_fields_settings button[data-toggle="modal"][data-target="#add_mapping_field_modal"]'),($submitButton=jQuery("#custom_tracker_settings_modal").find("#save_tracker_settings")).on("click",clickSaveCSVExport),$integrationCenterButtons.sendSingle.on("click",".upload_bug",clickSend),$integrationCenterButtons.sendSelected.on("click",clickSend),$integrationCenterButtons.sendAll.on("click",clickSend),$newMappingButton.on("click",newFieldMapping),$editMappingModalButton.on("click",editModalHandler)});